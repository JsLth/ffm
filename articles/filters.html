<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Filtering • ffm</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.10/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Roboto_Slab-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Filtering">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ffm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home"></span> Overview</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fa-search"></span> Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Filtering</h1>
            
      

      <div class="d-none name"><code>filters.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="attribute-filters">Attribute filters<a class="anchor" aria-label="anchor" href="#attribute-filters"></a>
</h2>
<p><code>ffm</code> supports certain R expressions for filtering WFS
servers. These expressions are not evaluated as-is but are converted to
valid CQL or XML in the background. Each filter expects a left-hand side
consisting of the name of a column in the output, an operator
(e.g. <code>==</code>), and a right-hand side consisting of values to
filter. It can look like this:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bkg_admin.html">bkg_admin</a></span><span class="op">(</span><span class="va">gen</span> <span class="op">==</span> <span class="st">"Berlin"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 1 feature and 25 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 4531042 ymin: 3253866 xmax: 4576603 ymax: 3290780</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89-extended / LAEA Europe</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 26</span></span>
<span><span class="co">#&gt;   objid   beginn       ade    gf   bsg ars   ags   sdv_ars gen   bez     ibz bem   nbd   sn_l  sn_r  sn_k  sn_v1 sn_v2 sn_g </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;   &lt;date&gt;     &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1 DEBKGV… 2023-10-03     4     4     1 11000 11000 110000… Berl… Krei…    40 --    ja    11    0     00    00    00    000  </span></span>
<span><span class="co">#&gt; # ℹ 7 more variables: fk_s3 &lt;chr&gt;, nuts &lt;chr&gt;, ars_0 &lt;chr&gt;, ags_0 &lt;chr&gt;, wsk &lt;date&gt;, dlm_id &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   geometry &lt;MULTIPOLYGON [m]&gt;</span></span></code></pre></div>
<p>This code downloads all districts where the column <code>gen</code>
(the geographical name) equals the string “Berlin”. While this might
seem intuitive at first, it can be quite frustrating to figure out which
columns there are to filter by and what values you can use as filters.
You have two options to find out. First, (probably) all attributes are
documented in the R documentation of the respective function as well as
the official documentation linked at the bottom of each function
reference page. Second, and more pragmatically, you can use the
<code>max</code> argument to control how many rows should be queried. In
the following example you can get a glance at how the output is
structured.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bkg_admin.html">bkg_admin</a></span><span class="op">(</span>max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 10 features and 25 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 4181887 ymin: 3361471 xmax: 4406278 ymax: 3551489</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89-extended / LAEA Europe</span></span>
<span><span class="co">#&gt; # A tibble: 10 × 26</span></span>
<span><span class="co">#&gt;    objid  beginn       ade    gf   bsg ars   ags   sdv_ars gen   bez     ibz bem   nbd   sn_l  sn_r  sn_k  sn_v1 sn_v2 sn_g </span></span>
<span><span class="co">#&gt;    &lt;chr&gt;  &lt;date&gt;     &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt;  1 DEBKG… 2022-12-19     4     4     1 01001 01001 010010… Flen… Krei…    40 --    ja    01    0     01    00    00    000  </span></span>
<span><span class="co">#&gt;  2 DEBKG… 2022-12-19     4     4     1 01002 01002 010020… Kiel  Krei…    40 --    ja    01    0     02    00    00    000  </span></span>
<span><span class="co">#&gt;  3 DEBKG… 2024-04-03     4     4     1 01003 01003 010030… Lübe… Krei…    40 --    ja    01    0     03    00    00    000  </span></span>
<span><span class="co">#&gt;  4 DEBKG… 2022-12-19     4     4     1 01004 01004 010040… Neum… Krei…    40 --    ja    01    0     04    00    00    000  </span></span>
<span><span class="co">#&gt;  5 DEBKG… 2024-04-03     4     4     1 01051 01051 010510… Dith… Kreis    42 --    ja    01    0     51    00    00    000  </span></span>
<span><span class="co">#&gt;  6 DEBKG… 2024-04-03     4     4     1 01053 01053 010530… Herz… Kreis    42 --    ja    01    0     53    00    00    000  </span></span>
<span><span class="co">#&gt;  7 DEBKG… 2024-04-03     4     4     1 01054 01054 010540… Nord… Kreis    42 --    ja    01    0     54    00    00    000  </span></span>
<span><span class="co">#&gt;  8 DEBKG… 2024-04-03     4     4     1 01055 01055 010550… Osth… Kreis    42 --    ja    01    0     55    00    00    000  </span></span>
<span><span class="co">#&gt;  9 DEBKG… 2023-10-03     4     4     1 01056 01056 010560… Pinn… Kreis    42 --    ja    01    0     56    00    00    000  </span></span>
<span><span class="co">#&gt; 10 DEBKG… 2023-10-03     4     4     1 01057 01057 010570… Plön  Kreis    42 --    ja    01    0     57    00    00    000  </span></span>
<span><span class="co">#&gt; # ℹ 7 more variables: fk_s3 &lt;chr&gt;, nuts &lt;chr&gt;, ars_0 &lt;chr&gt;, ags_0 &lt;chr&gt;, wsk &lt;date&gt;, dlm_id &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   geometry &lt;MULTIPOLYGON [m]&gt;</span></span></code></pre></div>
<p>While some columns are pretty obvious, others (e.g., <code>ade</code>
or <code>gf</code>) may warrant a look in the documentation.</p>
<p>A second consideration is which operator to use. Generally, there are
9 operators that can be used: <code>==</code>, <code>!=</code>,
<code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>,
<code>&gt;=</code>, <code>%LIKE%</code>, <code>%ILIKE%</code>, and
<code>%in%</code>. Other operators are not supported by CQL or XML and
will emit an error:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bkg_admin.html">bkg_admin</a></span><span class="op">(</span><span class="va">bem</span> <span class="op">&amp;&amp;</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in `FUN()`:</span></span>
<span><span class="co">#&gt; ! Operator `&amp;&amp;` is not supported in `bem &amp;&amp; 1`.</span></span>
<span><span class="co">#&gt; ℹ Try one of the following operators: ==, !=, &lt;, &gt;, &gt;=, &lt;=, %LIKE%, %ILIKE%, and %in%.</span></span></code></pre></div>
<p>While most operators are equivalent to their use in R,
<code>%LIKE%</code> and <code>%ILIKE%</code> stems from SQL and allows
for wildcard matching in strings. Instead of <code>*</code>, it uses
<code>%</code> as a wildcard operator.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bkg_admin.html">bkg_admin</a></span><span class="op">(</span><span class="va">gen</span> <span class="op">%LIKE%</span> <span class="st">"Ber%"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 4 features and 25 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 4082950 ymin: 2710124 xmax: 4576603 ymax: 3290780</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89-extended / LAEA Europe</span></span>
<span><span class="co">#&gt; # A tibble: 4 × 26</span></span>
<span><span class="co">#&gt;   objid   beginn       ade    gf   bsg ars   ags   sdv_ars gen   bez     ibz bem   nbd   sn_l  sn_r  sn_k  sn_v1 sn_v2 sn_g </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;   &lt;date&gt;     &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1 DEBKGV… 2024-04-03     4     4     1 06431 06431 064310… Berg… Land…    43 --    ja    06    4     31    00    00    000  </span></span>
<span><span class="co">#&gt; 2 DEBKGV… 2023-10-03     4     4     1 07231 07231 072310… Bern… Land…    43 --    ja    07    2     31    00    00    000  </span></span>
<span><span class="co">#&gt; 3 DEBKGV… 2021-12-13     4     4     1 09172 09172 091720… Berc… Land…    43 --    ja    09    1     72    00    00    000  </span></span>
<span><span class="co">#&gt; 4 DEBKGV… 2023-10-03     4     4     1 11000 11000 110000… Berl… Krei…    40 --    ja    11    0     00    00    00    000  </span></span>
<span><span class="co">#&gt; # ℹ 7 more variables: fk_s3 &lt;chr&gt;, nuts &lt;chr&gt;, ars_0 &lt;chr&gt;, ags_0 &lt;chr&gt;, wsk &lt;date&gt;, dlm_id &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   geometry &lt;MULTIPOLYGON [m]&gt;</span></span></code></pre></div>
<p>Unlike the previous example, this query does not return Berlin but
all districts that start with “Ber”.</p>
</div>
<div class="section level2">
<h2 id="spatial-filters">Spatial filters<a class="anchor" aria-label="anchor" href="#spatial-filters"></a>
</h2>
<p>Besides attribute filters, <code>ffm</code> is also able to construct
spatial filters. This means you can include or exclude certain areas of
your output before downloading by providing a boundary box or a polygon
geometry. You can do this by either providing a rectangular box,
e.g. like this:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">700000</span>, ymin <span class="op">=</span> <span class="fl">5900000</span>, xmax <span class="op">=</span> <span class="fl">850000</span>, ymax <span class="op">=</span> <span class="fl">6000000</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/bkg_admin.html">bkg_admin</a></span><span class="op">(</span>bbox <span class="op">=</span> <span class="va">bbox</span>, predicate <span class="op">=</span> <span class="st">"intersects"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 12 features and 25 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 4360521 ymin: 3280077 xmax: 4617795 ymax: 3514034</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89-extended / LAEA Europe</span></span>
<span><span class="co">#&gt; # A tibble: 12 × 26</span></span>
<span><span class="co">#&gt;    objid  beginn       ade    gf   bsg ars   ags   sdv_ars gen   bez     ibz bem   nbd   sn_l  sn_r  sn_k  sn_v1 sn_v2 sn_g </span></span>
<span><span class="co">#&gt;    &lt;chr&gt;  &lt;date&gt;     &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt;  1 DEBKG… 2024-04-03     4     4     1 12065 12065 120650… Ober… Land…    43 --    ja    12    0     65    00    00    000  </span></span>
<span><span class="co">#&gt;  2 DEBKG… 2024-04-03     4     4     1 12068 12068 120680… Ostp… Land…    43 --    ja    12    0     68    00    00    000  </span></span>
<span><span class="co">#&gt;  3 DEBKG… 2024-04-03     4     4     1 12070 12070 120700… Prig… Land…    43 --    ja    12    0     70    00    00    000  </span></span>
<span><span class="co">#&gt;  4 DEBKG… 2024-04-03     4     4     1 12073 12073 120730… Ucke… Land…    43 --    ja    12    0     73    00    00    000  </span></span>
<span><span class="co">#&gt;  5 DEBKG… 2023-10-03     4     4     1 13003 13003 130030… Rost… Krei…    40 --    ja    13    0     03    00    00    000  </span></span>
<span><span class="co">#&gt;  6 DEBKG… 2024-04-03     4     4     1 13071 13071 130710… Meck… Land…    43 --    ja    13    0     71    00    00    000  </span></span>
<span><span class="co">#&gt;  7 DEBKG… 2024-04-03     4     4     1 13072 13072 130720… Rost… Land…    43 --    ja    13    0     72    00    00    000  </span></span>
<span><span class="co">#&gt;  8 DEBKG… 2024-04-03     4     4     1 13073 13073 130730… Vorp… Land…    43 --    ja    13    0     73    00    00    000  </span></span>
<span><span class="co">#&gt;  9 DEBKG… 2024-04-03     4     4     1 13075 13075 130750… Vorp… Land…    43 --    ja    13    0     75    00    00    000  </span></span>
<span><span class="co">#&gt; 10 DEBKG… 2024-04-03     4     4     1 13076 13076 130760… Ludw… Land…    43 --    ja    13    0     76    00    00    000  </span></span>
<span><span class="co">#&gt; 11 DEBKG… 2023-10-03     4     2     1 13003 13003 130030… Rost… Krei…    40 --    ja    13    0     03    00    00    000  </span></span>
<span><span class="co">#&gt; 12 DEBKG… 2023-10-03     4     2     1 13075 13075 130750… Vorp… Land…    43 --    ja    13    0     75    00    00    000  </span></span>
<span><span class="co">#&gt; # ℹ 7 more variables: fk_s3 &lt;chr&gt;, nuts &lt;chr&gt;, ars_0 &lt;chr&gt;, ags_0 &lt;chr&gt;, wsk &lt;date&gt;, dlm_id &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   geometry &lt;MULTIPOLYGON [m]&gt;</span></span></code></pre></div>
<p>or by providing a polygon. Polygons are generally expressed using
<code>sf</code> or <code>sfc</code> objects from the <a href="https://r-spatial.github.io/sf/" class="external-link"><code>sf</code></a> package.
Using polygons you can provide much more complex geometries to filter
by.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">700000</span>, ymin <span class="op">=</span> <span class="fl">5900000</span>, xmax <span class="op">=</span> <span class="fl">850000</span>, ymax <span class="op">=</span> <span class="fl">6000000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">poly</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html" class="external-link">st_as_sfc</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/bkg_admin.html">bkg_admin</a></span><span class="op">(</span>poly <span class="op">=</span> <span class="va">poly</span>, predicate <span class="op">=</span> <span class="st">"intersects"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 12 features and 25 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 4360521 ymin: 3280077 xmax: 4617795 ymax: 3514034</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89-extended / LAEA Europe</span></span>
<span><span class="co">#&gt; # A tibble: 12 × 26</span></span>
<span><span class="co">#&gt;    objid  beginn       ade    gf   bsg ars   ags   sdv_ars gen   bez     ibz bem   nbd   sn_l  sn_r  sn_k  sn_v1 sn_v2 sn_g </span></span>
<span><span class="co">#&gt;    &lt;chr&gt;  &lt;date&gt;     &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt;  1 DEBKG… 2024-04-03     4     4     1 12065 12065 120650… Ober… Land…    43 --    ja    12    0     65    00    00    000  </span></span>
<span><span class="co">#&gt;  2 DEBKG… 2024-04-03     4     4     1 12068 12068 120680… Ostp… Land…    43 --    ja    12    0     68    00    00    000  </span></span>
<span><span class="co">#&gt;  3 DEBKG… 2024-04-03     4     4     1 12070 12070 120700… Prig… Land…    43 --    ja    12    0     70    00    00    000  </span></span>
<span><span class="co">#&gt;  4 DEBKG… 2024-04-03     4     4     1 12073 12073 120730… Ucke… Land…    43 --    ja    12    0     73    00    00    000  </span></span>
<span><span class="co">#&gt;  5 DEBKG… 2023-10-03     4     4     1 13003 13003 130030… Rost… Krei…    40 --    ja    13    0     03    00    00    000  </span></span>
<span><span class="co">#&gt;  6 DEBKG… 2024-04-03     4     4     1 13071 13071 130710… Meck… Land…    43 --    ja    13    0     71    00    00    000  </span></span>
<span><span class="co">#&gt;  7 DEBKG… 2024-04-03     4     4     1 13072 13072 130720… Rost… Land…    43 --    ja    13    0     72    00    00    000  </span></span>
<span><span class="co">#&gt;  8 DEBKG… 2024-04-03     4     4     1 13073 13073 130730… Vorp… Land…    43 --    ja    13    0     73    00    00    000  </span></span>
<span><span class="co">#&gt;  9 DEBKG… 2024-04-03     4     4     1 13075 13075 130750… Vorp… Land…    43 --    ja    13    0     75    00    00    000  </span></span>
<span><span class="co">#&gt; 10 DEBKG… 2024-04-03     4     4     1 13076 13076 130760… Ludw… Land…    43 --    ja    13    0     76    00    00    000  </span></span>
<span><span class="co">#&gt; 11 DEBKG… 2023-10-03     4     2     1 13003 13003 130030… Rost… Krei…    40 --    ja    13    0     03    00    00    000  </span></span>
<span><span class="co">#&gt; 12 DEBKG… 2023-10-03     4     2     1 13075 13075 130750… Vorp… Land…    43 --    ja    13    0     75    00    00    000  </span></span>
<span><span class="co">#&gt; # ℹ 7 more variables: fk_s3 &lt;chr&gt;, nuts &lt;chr&gt;, ars_0 &lt;chr&gt;, ags_0 &lt;chr&gt;, wsk &lt;date&gt;, dlm_id &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   geometry &lt;MULTIPOLYGON [m]&gt;</span></span></code></pre></div>
<p>Note how I simply converted the boundary box to an <code>sfc</code>
object and passed it as a polygon. One reason for this is because I am
to lazy to make an actual polygon geometry. The other reason is that
complex polygons can quickly push the limits of CQL queries.</p>
</div>
<div class="section level2">
<h2 id="cql-versus-xml-queries">CQL versus XML queries<a class="anchor" aria-label="anchor" href="#cql-versus-xml-queries"></a>
</h2>
<p>CQL (Common Query Language) is a query language that is often used
for WFS GET requests. It is rather simple and often almost matches the
syntax of R. XML (Extensible Markup Language) is a much more complicated
query language that is traditionally used for POST requests on WFS
servers. You can compare how filters look like by using the
<code><a href="../reference/wfs_filter.html">wfs_filter()</a></code> function:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/wfs_filter.html">wfs_filter</a></span><span class="op">(</span><span class="va">gen</span> <span class="op">==</span> <span class="st">"Berlin"</span>, lang <span class="op">=</span> <span class="st">"cql"</span><span class="op">)</span></span>
<span><span class="co">#&gt; gen = 'Berlin'</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/wfs_filter.html">wfs_filter</a></span><span class="op">(</span><span class="va">gen</span> <span class="op">==</span> <span class="st">"Berlin"</span>, lang <span class="op">=</span> <span class="st">"xml"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;fes:Filter&gt;</span></span>
<span><span class="co">#&gt;   &lt;fes:PropertyIsEqualTo&gt;</span></span>
<span><span class="co">#&gt;     &lt;fes:ValueReference&gt;gen&lt;/fes:ValueReference&gt;</span></span>
<span><span class="co">#&gt;     &lt;fes:Literal&gt;Berlin&lt;/fes:Literal&gt;</span></span>
<span><span class="co">#&gt;   &lt;/fes:PropertyIsEqualTo&gt;</span></span>
<span><span class="co">#&gt; &lt;/fes:Filter&gt;</span></span></code></pre></div>
<p>By default <code>ffm</code> uses CQL queries because they’re much
more reliable and don’t break as easily. However, URLs cannot exceed a
certain number of characters or they are declined by the WFS server.
This is particularly critical for spatial filters with complex polygons.
In the following, I load the federal state of Baden Wurttemberg and try
to retrieve all districts that intersect its geometry.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bkg_admin.html">bkg_admin</a></span><span class="op">(</span><span class="va">sn_l</span> <span class="op">==</span> <span class="st">"08"</span>, <span class="va">gf</span> <span class="op">==</span> <span class="fl">4</span>, level <span class="op">=</span> <span class="st">"lan"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/bkg_wfs.html">bkg_wfs</a></span><span class="op">(</span></span>
<span>  <span class="st">"vg5000_krs"</span>,</span>
<span>  endpoint <span class="op">=</span> <span class="st">"vg5000_0101"</span>,</span>
<span>  filter <span class="op">=</span> <span class="fu"><a href="../reference/wfs_filter.html">wfs_filter</a></span><span class="op">(</span>poly <span class="op">=</span> <span class="va">bw</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in `bkg_wfs()`:</span></span>
<span><span class="co">#&gt; ! Query is too large to be handled by CQL queries.</span></span>
<span><span class="co">#&gt; ℹ Consider setting `options(ffm_query_language = "xml")`.</span></span>
<span><span class="co">#&gt; ℹ Alternatively, try to reduce the size of your query.</span></span></code></pre></div>
<p>As the error tells us, you can switch between CQL and XML using
<code>options(ffm_query_language = "xml")</code>. This option switches
to XML queries for all requests made. Alternatively, you can use the
<code>lang</code> argument of <code><a href="../reference/wfs_filter.html">wfs_filter()</a></code>. Using XML
queries, the complex spatial filter of Baden Wurttemberg becomes
feasible:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>ffm_query_language <span class="op">=</span> <span class="st">"xml"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/bkg_wfs.html">bkg_wfs</a></span><span class="op">(</span></span>
<span>  <span class="st">"vg5000_krs"</span>,</span>
<span>  endpoint <span class="op">=</span> <span class="st">"vg5000_0101"</span>,</span>
<span>  filter <span class="op">=</span> <span class="fu"><a href="../reference/wfs_filter.html">wfs_filter</a></span><span class="op">(</span>poly <span class="op">=</span> <span class="va">bw</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Simple feature collection with 64 features and 25 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 4134332 ymin: 2684102 xmax: 4397824 ymax: 3014572</span></span>
<span><span class="co">#&gt; Projected CRS: ETRS89-extended / LAEA Europe</span></span>
<span><span class="co">#&gt; # A tibble: 64 × 26</span></span>
<span><span class="co">#&gt;    id     objid beginn       ade    gf   bsg ars   ags   sdv_ars gen   bez     ibz bem   nbd   sn_l  sn_r  sn_k  sn_v1 sn_v2</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;  &lt;chr&gt; &lt;date&gt;     &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt;  1 vg500… DEBK… 2019-10-03     4     9     1 06431 06431 064310… Berg… Land…    43 --    ja    06    4     31    00    00   </span></span>
<span><span class="co">#&gt;  2 vg500… DEBK… 2019-10-03     4     9     1 06437 06437 064370… Oden… Land…    43 --    nein  06    4     37    00    00   </span></span>
<span><span class="co">#&gt;  3 vg500… DEBK… 2019-10-03     4     9     1 07311 07311 073110… Fran… Krei…    40 --    ja    07    3     11    00    00   </span></span>
<span><span class="co">#&gt;  4 vg500… DEBK… 2019-10-03     4     9     1 07314 07314 073140… Ludw… Krei…    40 --    ja    07    3     14    00    00   </span></span>
<span><span class="co">#&gt;  5 vg500… DEBK… 2019-10-03     4     9     1 07318 07318 073180… Spey… Krei…    40 --    ja    07    3     18    00    00   </span></span>
<span><span class="co">#&gt;  6 vg500… DEBK… 2019-10-03     4     9     1 07334 07334 073340… Germ… Land…    43 --    ja    07    3     34    00    00   </span></span>
<span><span class="co">#&gt;  7 vg500… DEBK… 2019-10-03     4     9     1 07338 07338 073140… Rhei… Land…    43 --    nein  07    3     38    00    00   </span></span>
<span><span class="co">#&gt;  8 vg500… DEBK… 2019-10-03     4     9     1 08111 08111 081110… Stut… Stad…    41 --    ja    08    1     11    00    00   </span></span>
<span><span class="co">#&gt;  9 vg500… DEBK… 2019-10-03     4     9     1 08115 08115 081150… Böbl… Land…    43 --    ja    08    1     15    00    00   </span></span>
<span><span class="co">#&gt; 10 vg500… DEBK… 2019-10-03     4     9     1 08116 08116 081160… Essl… Land…    43 --    ja    08    1     16    00    00   </span></span>
<span><span class="co">#&gt; # ℹ 54 more rows</span></span>
<span><span class="co">#&gt; # ℹ 7 more variables: sn_g &lt;chr&gt;, fk_s3 &lt;chr&gt;, nuts &lt;chr&gt;, ars_0 &lt;chr&gt;, ags_0 &lt;chr&gt;, wsk &lt;date&gt;,</span></span>
<span><span class="co">#&gt; #   geometry &lt;MULTIPOLYGON [m]&gt;</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jonas Lieth.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
